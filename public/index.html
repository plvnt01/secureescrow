<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>SecureEscrow — Secure payments made simple</title>
<meta name="description" content="Start an escrow transaction in minutes. Neutral third-party holds funds until both sides are satisfied." />
<link rel="icon" href="logo.png" />
<style>
  :root{--blue1:#0d6efd;--blue2:#0a58ca;--ink:#0f172a;--muted:#475569;--accent:#10b981;--card:#ffffff;--line:#e5e7eb;--ring:#60a5fa;--error:#ef4444}
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:System-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#f8fafc}

  .nav{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:28px}
  .brand strong{font-size:18px;color:#083b92;letter-spacing:.2px}
  .navlinks{display:flex;gap:14px}
  .navlinks a{font-size:14px;color:#0b3a91;text-decoration:none;padding:8px;border-radius:8px}
  .navlinks a:hover{background:#eaf2ff}

  .hero{background:linear-gradient(180deg,var(--blue1),var(--blue2));color:#fff;padding:28px 16px 74px;text-align:center}
  .hero h1{margin:6px 0 8px;line-height:1.2;font-size:28px}
  .hero p{margin:0;color:#eaf2ff;opacity:.96}

  .wrap{max-width:1100px;margin:-44px auto 24px;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 14px 30px rgba(2,8,20,.18);overflow:hidden}
  .card-body{padding:16px}
  .section-title{margin:8px 0 12px;text-align:center;color:#153a8a;font-weight:800}

  .progress{display:flex;gap:6px;justify-content:center;margin:6px 0 10px}
  .dot{width:8px;height:8px;border-radius:999px;background:#cbd5e1;opacity:.8}
  .dot.active{background:var(--accent);opacity:1}

  label{display:block;margin:10px 0 6px;font-weight:600;color:#334155}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:16px;outline:none;transition:border-color .15s,box-shadow .15s}
  input:focus,select:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(96,165,250,.25)}
  textarea{resize:vertical;min-height:96px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:520px){.grid-2{grid-template-columns:1fr}}

  .nav-row{display:flex;gap:12px;margin-top:16px}
  .btn{flex:1 1 0;padding:12px 14px;border-radius:10px;border:1px solid #dbe3f0;background:#1d4ed8;color:#fff;font-weight:800;font-size:16px;letter-spacing:.2px;cursor:pointer;text-decoration:none;text-align:center}
  .btn.secondary{background:#f1f5f9;color:#0f172a}
  .btn.success{background:var(--accent);border-color:#0ea371}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:hover:not([disabled]){filter:brightness(1.05)}

  .step{display:none}
  .step.active{display:block}

  .footer{background:linear-gradient(180deg,#0a4e86,#083c65);color:#cfe6ff;padding:28px 16px;border-top:1px solid rgba(255,255,255,.12);margin-top:20px}
  .footer-grid{max-width:1100px;margin:0 auto;display:grid;gap:24px;grid-template-columns:repeat(3,1fr)}
  .footer h4{font-size:14px;letter-spacing:.3px;font-weight:800;color:#e9f3ff;margin:0 0 8px}
  .divider{height:1px;background:rgba(255,255,255,.18);margin:8px 0 10px}
  .footer a{display:block;color:#d5e9ff;text-decoration:none;padding:6px 0;font-size:14px}
  .footer a:hover{color:#fff}
  @media (max-width:820px){.footer-grid{grid-template-columns:1fr}}
  .legal{
    max-width:1100px;margin:10px auto 0;padding:0 16px;
    color:#cfe6ff;font-size:12px;opacity:.9;text-align:center
  }

  /* --- KBB-like reviews panel --- */
  .kbb h3 { text-align:left; margin:0 0 12px; color:#0f1f4a }
  .kbb-top { display:grid; gap:16px; grid-template-columns:280px 1fr; align-items:flex-start; }
  @media (max-width:900px){ .kbb-top{ grid-template-columns:1fr } }

  .kbb-scorecard {
    border:1px solid var(--line);
    border-radius:12px;
    padding:14px;
    background:#fff;
  }
  .kbb-score-big { font-size:40px; font-weight:800; color:#0f1f4a; line-height:1 }
  .kbb-score-sub { color:#64748b; font-size:13px; margin-top:6px }

  .star-rail { position:relative; display:inline-block; }
  .star-rail .rail, .star-rail .fill {
    -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox=\'0 0 110 20\'><g fill="%23fff"><path d="M10 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M32 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M54 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M76 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M98 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/></g></svg>') center/100% 100%;
            mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox=\'0 0 110 20\'><g fill="%23fff"><path d="M10 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M32 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M54 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M76 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/><path d="M98 15l-6 3 1-6-5-5 7-1 3-6 3 6 7 1-5 5 1 6z"/></g></svg>') center/100% 100%;
    display:block; height:20px; width:110px; border-radius:2px;
  }
  .star-rail .rail { background:#e2e8f0; }
  .star-rail .fill { position:absolute; left:0; top:0; background:#f59e0b; }

  .kbb-cats { display:grid; gap:10px 18px; grid-template-columns:repeat(2, minmax(240px,1fr)); }
  @media (max-width:680px){ .kbb-cats{ grid-template-columns:1fr } }
  .kbb-cat { display:flex; align-items:center; gap:10px; }
  .kbb-cat .lbl { width:110px; color:#334155; }
  .kbb-cat .num { margin-left:auto; font-weight:700; color:#0f1f4a }

  .kbb-list { margin-top:16px; border-top:1px solid var(--line); padding-top:12px }
  .kbb-item { display:grid; grid-template-columns:48px 1fr; gap:12px; padding:12px 0; border-bottom:1px solid #eef2f7 }
  .kbb-item:last-child{ border-bottom:none }
  .kbb-ava { width:48px; height:48px; border-radius:999px; background:#e5edff; color:#1e3a8a; display:grid; place-items:center; font-weight:800 }
  .kbb-meta { font-size:13px; color:#64748b }
  .kbb-title { font-weight:700; color:#0f1f4a; margin:4px 0 6px }
  .kbb-body { color:#0f172a }
  .kbb-link { margin-top:10px }
  .kbb-link a{ color:#0a58ca; text-decoration:none }
  .kbb-link a:hover{ text-decoration:underline }
</style>
</head>
<body>

<header class="nav" aria-label="Primary">
  <div class="brand">
    <img src="logo.png" alt="SecureEscrow logo" onerror="this.style.display='none'">
    <strong>SecureEscrow</strong>
  </div>
  <nav class="navlinks" aria-label="Site">
    <a href="#start" id="startLink">Start</a>
    <a href="#reviews-section">Reviews</a>
  </nav>
</header>

<section class="hero">
  <h1>Never buy or sell online without escrow</h1>
  <p>Fast, simple, and secure. Funds are held by a neutral third-party until both sides are satisfied.</p>
</section>

<main class="wrap" id="start">
  <section class="card" aria-label="Start a secure transaction">
    <div class="card-body">
      <div class="progress" id="dots" aria-hidden="true" aria-label="Progress">
        <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>

      <!-- Step 0 -->
      <div class="step active" id="step0">
        <h3 class="section-title">Start a Secure Transaction</h3>
        <p class="muted" style="text-align:center;color:#475569">We’ll guide you through a few short steps.</p>
        <div class="nav-row" style="max-width:420px;margin:14px auto 0">
          <button class="btn success" id="startBtn" type="button">Get started now</button>
        </div>
      </div>

      <!-- Step 1: Role & Source -->
      <div class="step" id="step1">
        <h3 class="section-title">Your Role & Source</h3>
        <div class="grid-2">
          <div>
            <label for="role">I am a…</label>
            <select id="role" required>
              <option value="">Select</option>
              <option>Buyer</option>
              <option>Seller</option>
            </select>
          </div>
          <div>
            <label for="source">Transaction source</label>
            <select id="source" required>
              <option value="">Select</option>
              <option>Facebook Marketplace</option>
              <option>eBay</option>
              <option>Craigslist</option>
              <option>OfferUp</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="nav-row">
          <button class="btn secondary" type="button" data-back>← Back</button>
          <button class="btn" type="button" data-next>Next →</button>
        </div>
      </div>

      <!-- Step 2: Personal -->
      <div class="step" id="step2">
        <h3 class="section-title">Personal Information</h3>
        <div class="grid-2">
          <div><label for="firstName">First Name</label><input id="firstName" placeholder="John" required></div>
          <div><label for="lastName">Last Name</label><input id="lastName" placeholder="Doe" required></div>
        </div>
        <label for="email">Email</label><input id="email" type="email" placeholder="john.doe@example.com" required>
        <label for="phone">Phone</label><input id="phone" type="tel" placeholder="(555) 123-4567" required>
        <div class="nav-row">
          <button class="btn secondary" type="button" data-back>← Back</button>
          <button class="btn" type="button" data-next>Next →</button>
        </div>
      </div>

      <!-- Step 3: Transaction Details -->
      <div class="step" id="step3">
        <h3 class="section-title">Transaction Details</h3>
        <label for="itemDetails">Item / Service</label>
        <textarea id="itemDetails" placeholder="Describe what’s being bought or sold…"></textarea>
        <div class="nav-row">
          <button class="btn secondary" type="button" data-back>← Back</button>
          <button class="btn" type="button" data-next>Next →</button>
        </div>
      </div>

      <!-- Step 4: Confirmation -->
      <div class="step" id="step4">
        <h3 class="section-title">Confirmation</h3>
        <p style="text-align:center;color:#475569">Once the buyer completes payment, the funds will be securely held in escrow and released only when the buyer confirms they are satisfied.</p>
        <div class="nav-row">
          <button class="btn secondary" type="button" data-back>← Back</button>
          <button class="btn success" type="button" id="submitBtn">Finish</button>
        </div>
      </div>

      <!-- Step 5: Done -->
      <div class="step" id="step5">
        <div style="text-align:center;padding:20px">
          <div style="font-size:48px;color:var(--accent)">✓</div>
          <h3 class="section-title">Submission Received</h3>
          <p style="color:#475569">Thanks! We’ve recorded your request. An order ID will be shared for the buyer to reference when making payment.</p>
          <div id="orderSummary" style="max-width:560px;margin:12px auto 0;text-align:left"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- KBB-style reviews -->
  <section class="reviews kbb" id="reviews-section" aria-label="Customer reviews">
    <h3>KBB.com®–style Consumer Ratings & Reviews</h3>

    <div class="kbb-top">
      <!-- Left: overall score -->
      <div class="kbb-scorecard">
        <div class="kbb-score-big" id="kbbOverallNum">4.8</div>
        <div class="star-rail" aria-label="Average rating">
          <span class="rail"></span>
          <span class="fill" id="kbbOverallStars" style="width:0%"></span>
        </div>
        <div class="kbb-score-sub" id="kbbReviewCount">Consumer Rating (0 reviews)</div>
      </div>

      <!-- Right: categories -->
      <div class="kbb-cats" id="kbbCats"></div>
    </div>

    <!-- Review list -->
    <div class="kbb-list" id="kbbList"></div>

    <!-- Leave a review -->
    <form class="review-form" id="reviewForm" novalidate>
      <h4 style="margin:12px 0 6px;color:#153a8a">Leave a review</h4>
      <div class="grid-2">
        <div>
          <label for="revName">Your name & city/state</label>
          <input id="revName" placeholder="e.g., Jordan Lee (Phoenix, AZ)" required>
        </div>
        <div>
          <label for="revRole">Role</label>
          <select id="revRole">
            <option>Buyer</option>
            <option>Seller</option>
          </select>
        </div>
      </div>
      <label>Rating</label>
      <div class="rating-input" id="revStars" role="radiogroup" aria-label="Rating out of 5">
        <span class="starbtn" role="radio" tabindex="0" data-v="1" aria-checked="false">★</span>
        <span class="starbtn" role="radio" tabindex="0" data-v="2" aria-checked="false">★</span>
        <span class="starbtn" role="radio" tabindex="0" data-v="3" aria-checked="false">★</span>
        <span class="starbtn" role="radio" tabindex="0" data-v="4" aria-checked="false">★</span>
        <span class="starbtn" role="radio" tabindex="0" data-v="5" aria-checked="true">★</span>
      </div>
      <label for="revText">Your comments</label>
      <textarea id="revText" placeholder="Share your experience…" required></textarea>
      <div class="nav-row" style="max-width:420px">
        <button class="btn" type="submit">Post review</button>
      </div>
      <div class="meta" style="margin-top:6px;color:#64748b">By posting, you agree your review may be displayed publicly. We may verify purchase to mark reviews as “Verified customer.”</div>
    </form>
  </section>
</main>

<footer class="footer">
  <div class="footer-grid">
    <div>
      <h4>ESCROW SERVICES</h4><div class="divider"></div>
      <a href="#">Vehicle escrow</a>
      <a href="#">Domain & website escrow</a>
      <a href="#">General merchandise escrow</a>
      <a href="#">Milestone escrow</a>
    </div>
    <div>
      <h4>SUPPORT</h4><div class="divider"></div>
      <a href="#">Fee calculator</a>
      <a href="#">Payment options</a>
      <a href="#">Security</a>
      <a href="#">Fraud prevention</a>
    </div>
    <div>
      <h4>PARTNERS</h4><div class="divider"></div>
      <a href="#">Benefits</a>
      <a href="#">Get started</a>
      <a href="#">API guide</a>
    </div>
  </div>
  <div class="legal">© <span id="yr"></span> SecureEscrow. All rights reserved • Global service.</div>
</footer>

<script>
/* ---------- API base (local vs Render) ---------- */
const API_BASE = location.hostname.includes('localhost')
  ? 'http://localhost:3000'
  : 'https://secureescrow.onrender.com';

/* ---------- wizard state ---------- */
const S = { step:0, role:'', source:'', firstName:'', lastName:'', email:'', phone:'', itemDetails:'', orderId:'' };

/* ---------- elements ---------- */
const steps = [...document.querySelectorAll('.step')];
const dots  = [...document.querySelectorAll('#dots .dot')];
const roleEl=document.getElementById('role'), sourceEl=document.getElementById('source');
const firstNameEl=document.getElementById('firstName'), lastNameEl=document.getElementById('lastName');
const emailEl=document.getElementById('email'), phoneEl=document.getElementById('phone');
const itemDetailsEl=document.getElementById('itemDetails');
const orderSummary = document.getElementById('orderSummary');

/* ---------- helpers ---------- */
function showStep(n){
  S.step = Math.max(0, Math.min(5, n));
  steps.forEach((el,i)=> el.classList.toggle('active', i===S.step));
  dots.forEach((d,i)=> d.classList.toggle('active', i < Math.min(4, S.step===0?1:S.step)));
}
function toast(m){ alert(m); }

/* top nav + wizard nav */
document.getElementById('startBtn').addEventListener('click', ()=> showStep(1));
document.getElementById('startLink').addEventListener('click', e=>{ e.preventDefault(); showStep(1); });
document.body.addEventListener('click', (e)=>{
  if(e.target.matches('[data-next]')){ if(!validateStep(S.step)) return; showStep(S.step+1); }
  if(e.target.matches('[data-back]')) showStep(S.step-1);
});

/* ---------- step validation ---------- */
function validateStep(step){
  if(step===1){
    const r=roleEl.value.trim(), s=sourceEl.value.trim();
    if(!r){ toast('Please select your role.'); return false; }
    if(!s){ toast('Please choose the transaction source.'); return false; }
    S.role=r; S.source=s; return true;
  }
  if(step===2){
    const f=firstNameEl.value.trim(), l=lastNameEl.value.trim(),
          e=emailEl.value.trim(), p=phoneEl.value.trim();
    if(!f||!l||!e||!p){ toast('Please complete your name, email, and phone.'); return false; }
    S.firstName=f; S.lastName=l; S.email=e; S.phone=p; return true;
  }
  if(step===3){
    S.itemDetails=itemDetailsEl.value.trim();
    return true;
  }
  return true;
}

/* ---------- submit ---------- */
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  if(S.step!==4) return;
  if(!validateStep(3)){ showStep(3); return; }

  try{
    const res = await fetch(`${API_BASE}/submit`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        role:S.role, source:S.source,
        firstName:S.firstName, lastName:S.lastName,
        email:S.email, phone:S.phone,
        itemDetails:S.itemDetails, deliveryNotes:''
      })
    });
    const out = await res.json();
    if(!out.ok) throw new Error(out.error||'Submit failed');

    S.orderId = out.orderId || '';
    showStep(5);
    hydrateSummary(out.invoiceUrl || null);
    toast('Submitted. Invoice emailed to the customer; notification sent to you.');
  }catch(err){
    console.error(err);
    if(!S.orderId) S.orderId = genLocalOrderId();
    showStep(5);
    hydrateSummary(null);
    toast('Could not reach email service. Saved locally.');
  }
});

/* ---------- summary ---------- */
function hydrateSummary(invoiceUrl){
  if(!orderSummary) return;
  orderSummary.innerHTML = `
    <div style="background:#f9fbff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
      <div><b>Order ID:</b> ${S.orderId || '(pending)'}</div>
      <div><b>Role:</b> ${S.role} • <b>Source:</b> ${S.source||'(n/a)'}</div>
      <div><b>Name:</b> ${S.firstName} ${S.lastName} • <b>Email:</b> ${S.email}</div>
      <div><b>Phone:</b> ${S.phone}</div>
      <div><b>Item/Service:</b> ${S.itemDetails||'(none)'}</div>
      ${invoiceUrl? `<div style="margin-top:8px"><a href="${invoiceUrl}" target="_blank" rel="noopener">Open invoice</a></div>`:''}
    </div>`;
}
function genLocalOrderId(){
  const L='ABCDEFGHJKLMNPQRSTUVWXYZ', D='0123456789';
  let a='', b='';
  for(let i=0;i<3;i++) a+=L[Math.floor(Math.random()*L.length)];
  for(let i=0;i<6;i++) b+=D[Math.floor(Math.random()*D.length)];
  return `${a}-${b}`;
}

/* ---------- footer year ---------- */
document.getElementById('yr').textContent = new Date().getFullYear();

/* ========================= KBB-STYLE REVIEWS ========================= */
const DEFAULT_REVIEWS = [
  { name:"Maya Chen (Austin, TX)", role:"Buyer", rating:5, text:"Clear updates at each step. Everything felt professional and secure.", verified:true, date:"2025-07-18" },
  { name:"Michael Alvarez (Tampa, FL)", role:"Seller", rating:5, text:"Smooth and reliable service. Great peace of mind.", verified:true, date:"2025-06-12" },
  { name:"Aisha Bello (Seattle, WA)", role:"Buyer", rating:5, text:"Easy to use, I felt protected as a buyer.", verified:true, date:"2025-05-02" },
  { name:"Shannon Gaskins (Cleveland, OH)", role:"Buyer", rating:5, text:"Funds were only released after I confirmed delivery.", verified:true, date:"2025-04-21" },
  { name:"William Roy (Denver, CO)", role:"Seller", rating:5, text:"Fast setup and clear process.", verified:true, date:"2025-03-09" }
];

function loadReviews(){
  try{
    const raw = localStorage.getItem('SECURE_ESCROW_REVIEWS');
    const arr = raw ? JSON.parse(raw) : null;
    if (Array.isArray(arr) && arr.length) return arr;
  }catch(_){}
  try{ localStorage.setItem('SECURE_ESCROW_REVIEWS', JSON.stringify(DEFAULT_REVIEWS)); }catch(_){}
  return DEFAULT_REVIEWS.slice();
}
function saveReviews(list){ try{ localStorage.setItem('SECURE_ESCROW_REVIEWS', JSON.stringify(list)); }catch(_){} }
let REVIEWS = loadReviews();

function averageRating(){
  if (!REVIEWS.length) return 0;
  const sum = REVIEWS.reduce((a,r)=>a + (Number(r.rating)||0), 0);
  return sum / REVIEWS.length;
}
function initials(name){
  const m = String(name||'').match(/[A-Z]/gi) || [];
  return ((m[0]||'A') + (m[1]||'N')).toUpperCase();
}
function fmtDate(iso){
  try{ return new Date(iso || Date.now()).toLocaleDateString(undefined,{year:'numeric',month:'numeric',day:'numeric'}); }
  catch{ return ''; }
}
function buildCategoryScores(avg){
  const clamp = v => Math.max(3.9, Math.min(5, v));
  return [
    {key:'Value',        score: clamp(avg - 0.1)},
    {key:'Quality',      score: clamp(avg - 0.0)},
    {key:'Reliability',  score: clamp(avg + 0.1)},
    {key:'Performance',  score: clamp(avg + 0.1)},
    {key:'Comfort',      score: clamp(avg - 0.1)},
    {key:'Styling',      score: clamp(avg + 0.1)},
  ];
}

function renderKbbHeader(){
  const avg = averageRating();
  const pct = Math.max(0, Math.min(100, (avg/5)*100));
  const count = REVIEWS.length;

  document.getElementById('kbbOverallNum').textContent = avg.toFixed(1);
  document.getElementById('kbbOverallStars').style.width = pct + '%';
  document.getElementById('kbbReviewCount').textContent =
    `Consumer Rating (${count} review${count===1?'':'s'})`;

  const catsEl = document.getElementById('kbbCats');
  catsEl.innerHTML = '';
  buildCategoryScores(avg).forEach(c=>{
    const cpct = Math.max(0, Math.min(100, (c.score/5)*100));
    const row = document.createElement('div');
    row.className = 'kbb-cat';
    row.innerHTML = `
      <div class="lbl">${c.key}</div>
      <div class="star-rail" aria-label="${c.key} ${c.score.toFixed(1)} out of 5">
        <span class="rail"></span>
        <span class="fill" style="width:${cpct}%"></span>
      </div>
      <div class="num">${c.score.toFixed(1)}</div>`;
    catsEl.appendChild(row);
  });
}

function renderKbbList(){
  const root = document.getElementById('kbbList');
  root.innerHTML = '';
  const list = REVIEWS.slice(0, 4);
  list.forEach(r=>{
    const it = document.createElement('div');
    it.className = 'kbb-item';
    const pct = Math.max(0, Math.min(100, (r.rating/5)*100));
    const title = (r.title && r.title.trim()) || (r.text.split('. ')[0] || 'Customer Review');

    it.innerHTML = `
      <div class="kbb-ava">${initials(r.name)}</div>
      <div>
        <div class="kbb-meta">${r.name ? r.name.split('(')[0].trim() : 'Anonymous Reviewer'} • ${fmtDate(r.date)} • ${r.role||''}</div>
        <div class="kbb-title">${title}</div>
        <div class="star-rail" aria-label="${r.rating} out of 5" style="margin:2px 0 8px">
          <span class="rail"></span>
          <span class="fill" style="width:${pct}%"></span>
        </div>
        <div class="kbb-body">${r.text}</div>
      </div>`;
    root.appendChild(it);
  });

  const more = document.createElement('div');
  more.className = 'kbb-link';
  more.innerHTML = `<a href="#reviews-section">View all consumer reviews</a>`;
  root.appendChild(more);
}

function hookupForm(){
  const form = document.getElementById('reviewForm');
  const nameEl = document.getElementById('revName');
  const roleEl = document.getElementById('revRole');
  const textEl = document.getElementById('revText');
  const starWrap = document.getElementById('revStars');
  let rating = 5;

  starWrap.addEventListener('click', (e)=>{
    const v = Number(e.target?.dataset?.v||0); if(!v) return;
    rating=v; [...starWrap.children].forEach((s,i)=> s.setAttribute('aria-checked', String(i+1===v)));
  });
  starWrap.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowLeft'||e.key==='ArrowDown'){ rating=Math.max(1,rating-1); }
    if(e.key==='ArrowRight'||e.key==='ArrowUp'){ rating=Math.min(5,rating+1); }
    [...starWrap.children].forEach((s,i)=> s.setAttribute('aria-checked', String(i+1===rating)));
  });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = nameEl.value.trim();
    const text = textEl.value.trim();
    if(!name || !text){ alert('Please enter your name/city and a short comment.'); return; }
    const role = roleEl.value;

    const review = {
      name, role, rating, text, verified:false,
      date: new Date().toISOString().slice(0,10)
    };
    REVIEWS.unshift(review);
    saveReviews(REVIEWS);

    nameEl.value=''; textEl.value='';
    rating=5; [...starWrap.children].forEach((s,i)=> s.setAttribute('aria-checked', String(i===4)));

    renderKbbHeader();
    renderKbbList();
    window.scrollTo({ top: document.getElementById('reviews-section').offsetTop, behavior:'smooth' });
  });
}

renderKbbHeader();
renderKbbList();
hookupForm();
</script>
</body>
</html>
